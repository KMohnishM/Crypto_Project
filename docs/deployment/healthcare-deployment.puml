@startuml HealthcareDeployment
skinparam shadowing false
skinparam defaultFontName Arial
skinparam nodesep 40
skinparam ranksep 30
skinparam wrapWidth 220
skinparam maxMessageSize 120

rectangle "User (Clinician/Admin)" as user <<actor>>

node "AWS Account" as aws {
  node "VPC (10.0.0.0/16)" as vpc {
    node "Public Subnet (10.0.1.0/24)" as pub {
      node "ALB (HTTPS 443)" as alb
      node "EC2: Docker Host" as ec2 {
        artifact "Docker Engine" as docker
        node "web_dashboard\nFlask (5000)" as wd <<container>>
        node "main_host\nFlask (8000)" as mh <<container>>
        node "ml_service\nFlask (6000)" as ml <<container>>
        node "patient_simulator\nPython (batch)" as ps <<container>>
        node "Prometheus (9090)" as prom <<container>>
        node "Grafana (3000)" as graf <<container>>
        node "Alertmanager (9093)" as am <<container>>
      }
    }
    node "DB Subnet Group (Private)" as dbsg {
      database "RDS MySQL (3306)" as rds
    }
  }
}

' External access
user --> alb : HTTPS 443
alb --> wd : HTTP 5000 (Target Group)

' App dependencies
wd --> mh : HTTP 8000\n/api/dashboard-data\n/api/patient/{id}
wd --> graf : HTTP 3000 (Embed dashboards)
wd --> rds : MySQL 3306 (SQLAlchemy)

' Simulator + ML
ps --> mh : HTTP 8000 /track (patient vitals)
ps --> ml : HTTP 6000 /predict (anomaly score)

' Monitoring
prom --> mh : HTTP 8000 /metrics (scrape)
graf --> prom : HTTP 9090 API (queries)
prom --> am : HTTP 9093 (alerts)

' Notes
note right of wd
Env-driven URLs:
- MAIN_HOST_URL
- GRAFANA_URL
- PROMETHEUS_URL
- ALERTMANAGER_URL
- DATABASE_URL (RDS)
end note

note right of graf
Grafana embedding enabled
(allow_embedding=true)
Dashboards visualize Prometheus
metrics from main_host.
end note

note right of rds
Encryption at rest + backups
Security Group: allow 3306 from
EC2/ECS only (least privilege).
end note

note bottom of ec2
EC2 Security Group allows:
- 5000 (web_dashboard from ALB)
- 8000 (main_host internal)
- 6000 (ml_service internal)
- 9090 (prom internal)
- 9093 (alertmanager internal)

Docker network: hospital_network
Containers communicate by name.
end note

@enduml