{% extends 'base_with_sidebar.html' %}

{% block title %}{% if patient %}{{ patient.first_name }} {{ patient.last_name }} - Details{% else %}Patient Not Found{% endif %} | Hospital Monitoring System{% endblock %}

{% block extra_css %}
<style>
    .patient-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 30px;
    }
    .status-badge {
        font-size: 1rem;
        padding: 8px 15px;
    }
    .info-card {
        height: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .info-card .card-header {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .vital-sign {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    .vital-sign:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .vital-value {
        font-size: 1.2rem;
        font-weight: bold;
    }
    .vital-normal {
        color: #28a745;
    }
    .vital-warning {
        color: #ffc107;
    }
    .vital-critical {
        color: #dc3545;
    }
    .chart-container {
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <h4>Error</h4>
    <p>{{ error }}</p>
    <a href="{{ url_for('patients.list_patients') }}" class="btn btn-primary">Back to Patients List</a>
</div>
{% elif patient %}
<div class="patient-header d-md-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center mb-3 mb-md-0">
        <div class="me-4">
            <i class="bi bi-person-circle" style="font-size: 4rem; color: #6c757d;"></i>
        </div>
        <div>
            <h1 class="mb-0">{{ patient.first_name }}{% if patient.last_name %} {{ patient.last_name }}{% endif %}</h1>
            <p class="mb-0">ID: {{ patient.patient_id }} | Location: {{ patient.hospital }}/{{ patient.dept }}/{{ patient.ward }}</p>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <span class="badge status-badge {% if patient.anomaly_score < 0.3 %}bg-success{% elif patient.anomaly_score < 0.7 %}bg-warning{% else %}bg-danger{% endif %} me-3">
            {% if patient.anomaly_score < 0.3 %}Normal{% elif patient.anomaly_score < 0.7 %}Warning{% else %}Critical{% endif %}
        </span>
        <div class="btn-group">
            <a href="{{ url_for('patients.list_patients') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Date of Birth:</strong></p>
                        <p>{{ patient.date_of_birth.strftime('%Y-%m-%d') }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Age:</strong></p>
                        <p>{{ patient.age }} years</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Gender:</strong></p>
                        <p>{{ patient.gender.capitalize() }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Blood Type:</strong></p>
                        <p>{{ patient.blood_type or 'Not recorded' }}</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Phone:</strong></p>
                        <p>{{ patient.phone or 'Not recorded' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Email:</strong></p>
                        <p>{{ patient.email or 'Not recorded' }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p class="mb-1"><strong>Address:</strong></p>
                        <p>{{ patient.address or 'Not recorded' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Medical Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Admission Date:</strong></p>
                        <p>{{ patient.admission_date.strftime('%Y-%m-%d') }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Days in Hospital:</strong></p>
                        <p>{{ patient.days_in_hospital }} days</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Height:</strong></p>
                        <p>{{ patient.height or 'Not recorded' }} cm</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Weight:</strong></p>
                        <p>{{ patient.weight or 'Not recorded' }} kg</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <p class="mb-1"><strong>Allergies:</strong></p>
                        <p>{{ patient.allergies or 'None recorded' }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p class="mb-1"><strong>Current Medications:</strong></p>
                        <p>{{ patient.current_medications or 'None recorded' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Current Vital Signs</h5>
                <a href="#" class="btn btn-sm btn-outline-primary">View History</a>
            </div>
            <div class="card-body">
                {% if patient.heart_rate %}
                <div class="vital-sign">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0">Heart Rate</p>
                            <small class="text-muted">Normal range: 60-100 bpm</small>
                        </div>
                        <div class="vital-value {% if patient.heart_rate < 60 or patient.heart_rate > 100 %}vital-warning{% else %}vital-normal{% endif %}">
                            {{ patient.heart_rate|round|int }} bpm
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if patient.bp_systolic and patient.bp_diastolic %}
                <div class="vital-sign">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0">Blood Pressure</p>
                            <small class="text-muted">Normal range: 90/60 - 120/80 mmHg</small>
                        </div>
                        <div class="vital-value {% if patient.bp_systolic > 140 or patient.bp_diastolic > 90 %}vital-warning{% else %}vital-normal{% endif %}">
                            {{ patient.bp_systolic|round|int }}/{{ patient.bp_diastolic|round|int }} mmHg
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if patient.temperature %}
                <div class="vital-sign">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0">Temperature</p>
                            <small class="text-muted">Normal range: 36.1-37.2째C</small>
                        </div>
                        <div class="vital-value {% if patient.temperature < 36.1 or patient.temperature > 37.2 %}vital-warning{% else %}vital-normal{% endif %}">
                            {{ "%.1f"|format(patient.temperature) }}째C
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if patient.respiratory_rate %}
                <div class="vital-sign">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0">Respiratory Rate</p>
                            <small class="text-muted">Normal range: 12-20 breaths/min</small>
                        </div>
                        <div class="vital-value {% if patient.respiratory_rate < 12 or patient.respiratory_rate > 20 %}vital-warning{% else %}vital-normal{% endif %}">
                            {{ patient.respiratory_rate|round|int }} breaths/min
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if patient.spo2 %}
                <div class="vital-sign">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0">Blood Oxygen</p>
                            <small class="text-muted">Normal range: 95-100%</small>
                        </div>
                        <div class="vital-value {% if patient.spo2 < 95 %}vital-warning{% else %}vital-normal{% endif %}">
                            {{ patient.spo2|round|int }}%
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> 
                        Last updated: {% if patient.timestamp %}{{ patient.timestamp }}{% else %}Real-time{% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Monitoring Devices</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Status</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Heart Rate Monitor</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>Just now</td>
                            </tr>
                            <tr>
                                <td>Blood Pressure Monitor</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>2 minutes ago</td>
                            </tr>
                            <tr>
                                <td>Temperature Sensor</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>5 minutes ago</td>
                            </tr>
                            <tr>
                                <td>Pulse Oximeter</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>Just now</td>
                            </tr>
                            <tr>
                                <td>Ventilator</td>
                                <td><span class="badge bg-secondary">Not Connected</span></td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card info-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Vital Signs Trends</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary active">6 Hours</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">24 Hours</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">7 Days</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="vitalSignsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Medical History</h5>
            </div>
            <div class="card-body">
                <p>{{ patient.medical_history or 'No medical history recorded.' }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card info-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Emergency Contact</h5>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ patient.emergency_contact_name or 'Not recorded' }}</p>
                <p><strong>Relationship:</strong> {{ patient.emergency_contact_relationship or 'Not recorded' }}</p>
                <p><strong>Phone:</strong> {{ patient.emergency_contact_phone or 'Not recorded' }}</p>
                <p><strong>Address:</strong> {{ patient.emergency_contact_address or 'Not recorded' }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete patient <strong>{{ patient.first_name }} {{ patient.last_name }}</strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                {# <form action="{{ url_for('patients.delete_patient', patient_id=patient.id) }}" method="POST"> #}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <h4>No Patient Data</h4>
    <p>Patient information is not available.</p>
    <a href="{{ url_for('patients.list_patients') }}" class="btn btn-primary">Back to Patients List</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sample data for the vital signs chart
        const ctx = document.getElementById('vitalSignsChart').getContext('2d');
        
        // Time labels for the last 6 hours (one reading every 30 minutes)
        const timeLabels = [];
        for (let i = 12; i >= 0; i--) {
            const hour = i / 2;
            timeLabels.push(hour === 0 ? 'Now' : `${hour} hr ago`);
        }
        
        // Sample data for heart rate
        const heartRateData = [75, 78, 80, 82, 85, 90, 95, 100, 110, 120, 128, 135, 135];
        
        // Sample data for blood oxygen
        const bloodOxygenData = [98, 98, 97, 97, 96, 96, 95, 95, 94, 93, 92, 92, 92];
        
        // Sample data for temperature
        const temperatureData = [36.8, 36.9, 37.0, 37.0, 37.1, 37.1, 37.1, 37.0, 37.0, 37.1, 37.1, 37.1, 37.1];
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Heart Rate (bpm)',
                        data: heartRateData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Blood Oxygen (%)',
                        data: bloodOxygenData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        yAxisID: 'y1',
                        tension: 0.3
                    },
                    {
                        label: 'Temperature (째C)',
                        data: temperatureData,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        yAxisID: 'y2',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Heart Rate (bpm)'
                        },
                        min: 60,
                        max: 140,
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Blood Oxygen (%)'
                        },
                        min: 90,
                        max: 100,
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Temperature (째C)'
                        },
                        min: 36,
                        max: 38,
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                }
            }
        });
    });
</script>
{% endblock %}