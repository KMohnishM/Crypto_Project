{% extends 'base_with_sidebar.html' %}

{% block title %}Patients | Hospital Monitoring System{% endblock %}

{% block sidebar %}
<div class="p-3">
    <h6 class="text-muted text-uppercase">Navigation</h6>
    <nav class="nav flex-column">
        <a class="nav-link" href="{{ url_for('main.index') }}">
            <i class="bi bi-house-door"></i> Dashboard
        </a>
        <a class="nav-link active" href="{{ url_for('patients.list_patients') }}">
            <i class="bi bi-people"></i> All Patients
        </a>
        <a class="nav-link" href="{{ url_for('main.analytics') }}">
            <i class="bi bi-graph-up"></i> Analytics
        </a>
        <a class="nav-link" href="{{ url_for('main.monitoring') }}">
            <i class="bi bi-activity"></i> Monitoring
        </a>
    </nav>
</div>

<div class="p-3 border-top">
    <h6 class="text-muted text-uppercase">Patients List</h6>
    <div class="mb-3">
        <input type="text" class="form-control form-control-sm" placeholder="Search patients..." id="sidebar-search">
    </div>
    
    <div id="patients-sidebar-list">
        {% if patients %}
            {% for patient in patients %}
            <div class="sidebar-patient-item" data-patient-id="{{ patient.patient_id }}" onclick="showPatientDetails('{{ patient.patient_id }}')">
                <div class="d-flex align-items-center">
                    <span class="patient-status {% if patient.anomaly_score < 0.3 %}status-normal{% elif patient.anomaly_score < 0.7 %}status-warning{% else %}status-critical{% endif %}"></span>
                    <div class="flex-grow-1">
                        <div class="fw-bold">{{ patient.first_name }}{% if patient.last_name %} {{ patient.last_name }}{% endif %}</div>
                        <small class="text-muted">{{ patient.hospital }}/{{ patient.dept }}/{{ patient.ward }}</small>
                    </div>
                </div>
                <div class="mt-1">
                    <small class="text-muted">
                        {% if patient.heart_rate %}HR: {{ patient.heart_rate|int }}{% endif %}
                        {% if patient.spo2 %} | SpO2: {{ patient.spo2|int }}%{% endif %}
                    </small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center text-muted py-3">
                <i class="bi bi-person-x"></i><br>
                No patients found
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Data Source Info -->
<div class="alert alert-success mb-3" role="alert">
    <strong>Data Source:</strong> Main Host API (http://main_host:8000/api/dashboard-data) - Same as home page
</div>

<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-people"></i> Patient Management</h1>
        <p class="text-muted">Monitor and manage patient information in real-time</p>
    </div>
    <div>
        <button class="btn btn-primary" onclick="refreshPatientData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h2 id="total-patients-count">{{ patients|length }}</h2>
                <p class="mb-0">Total Patients</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h2 id="normal-patients-count">
                    {% set normal_count = patients|selectattr('anomaly_score', 'lt', 0.3)|list|length %}
                    {{ normal_count }}
                </h2>
                <p class="mb-0">Normal</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h2 id="warning-patients-count">
                    {% set warning_count = patients|selectattr('anomaly_score', 'ge', 0.3)|selectattr('anomaly_score', 'lt', 0.7)|list|length %}
                    {{ warning_count }}
                </h2>
                <p class="mb-0">Warning</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h2 id="critical-patients-count">
                    {% set critical_count = patients|selectattr('anomaly_score', 'ge', 0.7)|list|length %}
                    {{ critical_count }}
                </h2>
                <p class="mb-0">Critical</p>
            </div>
        </div>
    </div>
</div>

<!-- Patient Details Panel -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-circle"></i> 
                    <span id="selected-patient-name">Select a patient from the sidebar</span>
                </h5>
            </div>
            <div class="card-body" id="patient-details-body">
                <div class="text-center py-5">
                    <i class="bi bi-person-plus" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="text-muted mt-3">Click on a patient from the sidebar to view their details</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Table View (Optional) -->
<div class="row mt-4" style="display: none;" id="table-view">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> Patients Table View
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Patient ID</th>
                                <th>Name</th>
                                <th>Hospital</th>
                                <th>Department/Ward</th>
                                <th>Heart Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if patients %}
                                {% for patient in patients %}
                                <tr>
                                    <td>
                                        <span class="patient-status {% if patient.anomaly_score < 0.3 %}status-normal{% elif patient.anomaly_score < 0.7 %}status-warning{% else %}status-critical{% endif %}"></span>
                                        {% if patient.anomaly_score < 0.3 %}Normal{% elif patient.anomaly_score < 0.7 %}Warning{% else %}Critical{% endif %}
                                    </td>
                                    <td>{{ patient.patient_id }}</td>
                                    <td>{{ patient.first_name }}{% if patient.last_name %} {{ patient.last_name }}{% endif %}</td>
                                    <td>{{ patient.hospital }}</td>
                                    <td>{{ patient.dept }}/{{ patient.ward }}</td>
                                    <td>{% if patient.heart_rate %}{{ patient.heart_rate|int }} BPM{% endif %}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="showPatientDetails('{{ patient.patient_id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No patients found.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="patients-data">
{% if patients %}{{ patients | tojson | safe }}{% else %}[]{% endif %}
</script>
<script>
// Store patient data globally
let patientsData = JSON.parse(document.getElementById('patients-data').textContent);

// Function to show patient details
function showPatientDetails(patientId) {
    // Find patient in data
    const patient = patientsData.find(p => p.patient_id == patientId);
    if (!patient) {
        console.error('Patient not found:', patientId);
        return;
    }

    // Update sidebar selection
    document.querySelectorAll('.sidebar-patient-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-patient-id="${patientId}"]`).classList.add('active');

    // Update main panel
    document.getElementById('selected-patient-name').textContent = 
        patient.first_name + (patient.last_name ? ' ' + patient.last_name : '');

    // Create comprehensive patient details with all available information
    let detailsHtml = '<div class="row">';
    
    // Patient Information Card
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<div class="card mb-3">';
    detailsHtml += '<div class="card-header"><h6><i class="bi bi-person-badge"></i> Patient Information</h6></div>';
    detailsHtml += '<div class="card-body">';
    detailsHtml += '<table class="table table-borderless table-sm">';
    detailsHtml += '<tr><td><strong>Patient ID:</strong></td><td>' + patient.patient_id + '</td></tr>';
    detailsHtml += '<tr><td><strong>Name:</strong></td><td>' + patient.first_name + (patient.last_name ? ' ' + patient.last_name : '') + '</td></tr>';
    detailsHtml += '<tr><td><strong>Hospital:</strong></td><td>Hospital ' + patient.hospital + '</td></tr>';
    detailsHtml += '<tr><td><strong>Department:</strong></td><td>Department ' + patient.dept + '</td></tr>';
    detailsHtml += '<tr><td><strong>Ward:</strong></td><td>Ward ' + patient.ward + '</td></tr>';
    detailsHtml += '<tr><td><strong>Location:</strong></td><td>' + patient.hospital + '/' + patient.dept + '/' + patient.ward + '</td></tr>';
    // Removed Last Update timestamp
    detailsHtml += '</table></div></div>';
    
    // Alert Status Card
    const statusClass = patient.anomaly_score < 0.3 ? 'status-normal' : patient.anomaly_score < 0.7 ? 'status-warning' : 'status-critical';
    const statusText = patient.anomaly_score < 0.3 ? 'Normal' : patient.anomaly_score < 0.7 ? 'Warning' : 'Critical';
    const statusBg = patient.anomaly_score < 0.3 ? 'bg-success' : patient.anomaly_score < 0.7 ? 'bg-warning' : 'bg-danger';
    detailsHtml += '<div class="card">';
    detailsHtml += '<div class="card-header ' + statusBg + ' text-white"><h6><i class="bi bi-exclamation-triangle"></i> Alert Status: ' + statusText + '</h6></div>';
    detailsHtml += '<div class="card-body">';
    detailsHtml += '<div class="d-flex align-items-center mb-2">';
    detailsHtml += '<span class="patient-status ' + statusClass + ' me-2"></span>';
    detailsHtml += '<strong class="me-3">' + statusText + '</strong>';
    detailsHtml += '<span class="badge ' + statusBg + '">' + patient.anomaly_score.toFixed(3) + '</span>';
    detailsHtml += '</div>';
    if (patient.anomaly_score >= 0.7) {
        detailsHtml += '<div class="alert alert-danger mb-0"><small><i class="bi bi-exclamation-triangle"></i> <strong>CRITICAL:</strong> Immediate attention required!</small></div>';
    } else if (patient.anomaly_score >= 0.3) {
        detailsHtml += '<div class="alert alert-warning mb-0"><small><i class="bi bi-exclamation-circle"></i> <strong>WARNING:</strong> Patient requires monitoring</small></div>';
    } else {
        detailsHtml += '<div class="alert alert-success mb-0"><small><i class="bi bi-check-circle"></i> <strong>NORMAL:</strong> Patient vitals within normal range</small></div>';
    }
    detailsHtml += '</div></div></div>';
    
    // Comprehensive Vital Signs Card
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<div class="card mb-3">';
    detailsHtml += '<div class="card-header"><h6><i class="bi bi-heart-pulse"></i> Complete Vital Signs</h6></div>';
    detailsHtml += '<div class="card-body"><div class="row">';
    
    // Heart Rate
    if (patient.heart_rate) {
        const hrClass = patient.heart_rate < 60 || patient.heart_rate > 100 ? 'text-danger' : 'text-primary';
        const hrStatus = patient.heart_rate < 60 ? 'Bradycardia' : patient.heart_rate > 100 ? 'Tachycardia' : 'Normal';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + hrClass + '">' + Math.round(patient.heart_rate) + '</h4>';
        detailsHtml += '<small class="text-muted">Heart Rate (BPM)</small>';
        detailsHtml += '<br><small class="text-muted">Normal: 60-100</small>';
        detailsHtml += '<br><small class="' + hrClass + '"><strong>' + hrStatus + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    // SpO2
    if (patient.spo2) {
        const spo2Class = patient.spo2 < 95 ? 'text-danger' : patient.spo2 < 98 ? 'text-warning' : 'text-success';
        const spo2Status = patient.spo2 < 95 ? 'Low' : patient.spo2 < 98 ? 'Acceptable' : 'Excellent';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + spo2Class + '">' + Math.round(patient.spo2) + '%</h4>';
        detailsHtml += '<small class="text-muted">Oxygen Saturation</small>';
        detailsHtml += '<br><small class="text-muted">Normal: >95%</small>';
        detailsHtml += '<br><small class="' + spo2Class + '"><strong>' + spo2Status + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    // Temperature
    if (patient.temperature) {
        const tempClass = patient.temperature < 36.1 || patient.temperature > 37.2 ? 'text-danger' : 'text-success';
        const tempStatus = patient.temperature < 36.1 ? 'Hypothermia' : patient.temperature > 37.2 ? 'Fever' : 'Normal';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + tempClass + '">' + patient.temperature.toFixed(1) + '°C</h4>';
        detailsHtml += '<small class="text-muted">Body Temperature</small>';
        detailsHtml += '<br><small class="text-muted">Normal: 36.1-37.2°C</small>';
        detailsHtml += '<br><small class="' + tempClass + '"><strong>' + tempStatus + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    // Blood Pressure
    if (patient.bp_systolic && patient.bp_diastolic) {
        const bpClass = patient.bp_systolic > 140 || patient.bp_diastolic > 90 ? 'text-danger' : patient.bp_systolic > 120 || patient.bp_diastolic > 80 ? 'text-warning' : 'text-success';
        const bpStatus = patient.bp_systolic > 140 || patient.bp_diastolic > 90 ? 'Hypertension' : patient.bp_systolic > 120 || patient.bp_diastolic > 80 ? 'Elevated' : 'Normal';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + bpClass + '">' + Math.round(patient.bp_systolic) + '/' + Math.round(patient.bp_diastolic) + '</h4>';
        detailsHtml += '<small class="text-muted">Blood Pressure (mmHg)</small>';
        detailsHtml += '<br><small class="text-muted">Normal: <120/80</small>';
        detailsHtml += '<br><small class="' + bpClass + '"><strong>' + bpStatus + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    // Respiratory Rate
    if (patient.respiratory_rate) {
        const rrClass = patient.respiratory_rate < 12 || patient.respiratory_rate > 20 ? 'text-warning' : 'text-success';
        const rrStatus = patient.respiratory_rate < 12 ? 'Bradypnea' : patient.respiratory_rate > 20 ? 'Tachypnea' : 'Normal';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + rrClass + '">' + Math.round(patient.respiratory_rate) + '</h4>';
        detailsHtml += '<small class="text-muted">Respiratory Rate</small>';
        detailsHtml += '<br><small class="text-muted">Normal: 12-20</small>';
        detailsHtml += '<br><small class="' + rrClass + '"><strong>' + rrStatus + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    // Blood Glucose
    if (patient.blood_glucose) {
        const bgClass = patient.blood_glucose < 70 || patient.blood_glucose > 140 ? 'text-danger' : patient.blood_glucose > 100 ? 'text-warning' : 'text-success';
        const bgStatus = patient.blood_glucose < 70 ? 'Hypoglycemia' : patient.blood_glucose > 140 ? 'Hyperglycemia' : patient.blood_glucose > 100 ? 'Elevated' : 'Normal';
        detailsHtml += '<div class="col-6 mb-3">';
        detailsHtml += '<div class="text-center p-3 bg-light rounded border">';
        detailsHtml += '<h4 class="' + bgClass + '">' + Math.round(patient.blood_glucose) + '</h4>';
        detailsHtml += '<small class="text-muted">Blood Glucose (mg/dL)</small>';
        detailsHtml += '<br><small class="text-muted">Normal: 70-100</small>';
        detailsHtml += '<br><small class="' + bgClass + '"><strong>' + bgStatus + '</strong></small>';
        detailsHtml += '</div></div>';
    }
    
    detailsHtml += '</div></div></div></div></div>';
    
    // Additional Medical Information
    detailsHtml += '<div class="row mt-3">';
    
    // Medical History/Notes (if available)
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<div class="card">';
    detailsHtml += '<div class="card-header"><h6><i class="bi bi-journal-medical"></i> Medical Information</h6></div>';
    detailsHtml += '<div class="card-body">';
    detailsHtml += '<table class="table table-borderless table-sm">';
    if (patient.age) detailsHtml += '<tr><td><strong>Age:</strong></td><td>' + patient.age + ' years</td></tr>';
    if (patient.gender) detailsHtml += '<tr><td><strong>Gender:</strong></td><td>' + patient.gender + '</td></tr>';
    if (patient.admission_date) detailsHtml += '<tr><td><strong>Admission:</strong></td><td>' + new Date(patient.admission_date).toLocaleDateString() + '</td></tr>';
    if (patient.diagnosis) detailsHtml += '<tr><td><strong>Diagnosis:</strong></td><td>' + patient.diagnosis + '</td></tr>';
    if (patient.allergies) detailsHtml += '<tr><td><strong>Allergies:</strong></td><td>' + patient.allergies + '</td></tr>';
    detailsHtml += '<tr><td><strong>Risk Level:</strong></td><td><span class="badge ' + statusBg + '">' + statusText + '</span></td></tr>';
    detailsHtml += '</table>';
    detailsHtml += '</div></div></div>';
    
    // Real-time Actions
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<div class="card">';
    detailsHtml += '<div class="card-header"><h6><i class="bi bi-activity"></i> Real-time Monitoring</h6></div>';
    detailsHtml += '<div class="card-body">';
    detailsHtml += '<div class="d-grid gap-2">';
    detailsHtml += '<button class="btn btn-primary btn-sm" onclick="refreshPatientData()"><i class="bi bi-arrow-clockwise"></i> Refresh Data</button>';
    detailsHtml += '<button class="btn btn-success btn-sm" onclick="exportPatientData(\'' + patient.patient_id + '\')"><i class="bi bi-download"></i> Export Data</button>';
    detailsHtml += '<button class="btn btn-info btn-sm" onclick="showVitalTrends(\'' + patient.patient_id + '\')"><i class="bi bi-graph-up"></i> View Trends</button>';
    if (patient.anomaly_score >= 0.3) {
        detailsHtml += '<button class="btn btn-warning btn-sm" onclick="acknowledgeAlert(\'' + patient.patient_id + '\')"><i class="bi bi-check-circle"></i> Acknowledge Alert</button>';
    }
    detailsHtml += '</div>';
    detailsHtml += '<hr>';
    detailsHtml += '<p class="mb-0 text-muted small">';
    detailsHtml += '<i class="bi bi-info-circle"></i> Live monitoring from Hospital System<br>';
    // Removed Last Update timestamp
    detailsHtml += '<strong>Data Source:</strong> Main Host API<br>';
    detailsHtml += '<strong>Auto-refresh:</strong> Every 30 seconds';
    detailsHtml += '</p>';
    detailsHtml += '</div></div></div>';
    detailsHtml += '</div>';

    document.getElementById('patient-details-body').innerHTML = detailsHtml;
}

// Additional patient management functions
function exportPatientData(patientId) {
    const patient = patientsData.find(p => p.patient_id == patientId);
    if (!patient) return;
    
    const dataStr = JSON.stringify(patient, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'patient_' + patientId + '_data.json';
    link.click();
    URL.revokeObjectURL(url);
}

function showVitalTrends(patientId) {
    alert('Vital trends analysis for Patient ' + patientId + ' would show historical data charts here. This feature connects to the monitoring system for trend analysis.');
}

function acknowledgeAlert(patientId) {
    if (confirm('Acknowledge alert for Patient ' + patientId + '? This will mark the alert as reviewed by medical staff.')) {
        alert('Alert acknowledged for Patient ' + patientId + '. This would normally update the alert status in the hospital system.');
    }
}

// Function to refresh patient data
function refreshPatientData() {
    location.reload();
}

// Sidebar search functionality
document.getElementById('sidebar-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const patientItems = document.querySelectorAll('.sidebar-patient-item');
    
    patientItems.forEach(item => {
        const patientName = item.querySelector('.fw-bold').textContent.toLowerCase();
        const patientLocation = item.querySelector('.text-muted').textContent.toLowerCase();
        
        if (patientName.includes(searchTerm) || patientLocation.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Auto-select first patient if available and setup auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    if (patientsData && patientsData.length > 0) {
        showPatientDetails(patientsData[0].patient_id);
    }
    
    // Auto-refresh every 30 seconds for real-time updates
    setInterval(function() {
        // Only refresh if we're still on the patients page
        if (window.location.pathname === '/patients') {
            console.log('Auto-refreshing patient data...');
            refreshPatientData();
        }
    }, 30000); // 30 seconds
    
    // Add refresh indicator
    const refreshIndicator = document.createElement('div');
    refreshIndicator.id = 'refresh-indicator';
    refreshIndicator.innerHTML = '<small class="text-muted"><i class="bi bi-arrow-clockwise"></i> Auto-refresh: 30s</small>';
    refreshIndicator.style.position = 'fixed';
    refreshIndicator.style.bottom = '10px';
    refreshIndicator.style.right = '10px';
    refreshIndicator.style.background = 'rgba(0,0,0,0.7)';
    refreshIndicator.style.color = 'white';
    refreshIndicator.style.padding = '5px 10px';
    refreshIndicator.style.borderRadius = '5px';
    refreshIndicator.style.fontSize = '12px';
    document.body.appendChild(refreshIndicator);
});
</script>

{% endblock %}